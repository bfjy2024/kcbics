<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2024-2025-2è¯¾ç¨‹è¡¨</title>
    <style>
        :root {
            --class1: #e8f4ff; --class2: #f0f8ff;
            --class3: #f5f3ff; --class4: #fff0f5;
            --active-week: #007AFF;
        }
        
        body {
            font-family: -apple-system, system-ui;
            background: #f5f5f7;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }



        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
        
            .week-nav button {
                padding: 6px 10px;
                font-size: 14px;
            }
        
            .week-card {
                padding: 15px;
                border-radius: 12px;
            }
        
            th, td {
                padding: 8px;
                font-size: 14px;
            }
        
            .time-col {
                width: 70px;
                font-size: 13px;
            }
        
            .holiday-mark {
                right: 2px;
                bottom: 2px;
            }
        
            .holiday-text {
                font-size: 12px;
                padding: 1px 4px;
            }
        }
    
        /* èŠ‚å‡æ—¥æ ‡è®°æ ·å¼ */
        .holiday-mark {
            position: absolute;
            right: 4px;
            bottom: 4px;
            z-index: 2;
            display: flex;
            align-items: center;
        }
        
        .holiday-text {
            background: rgba(255, 235, 59, 0.9);
            color: #c62828;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .holiday-line {
            width: 12px;
            height: 2px;
            background: #c62828;
            margin-left: 4px;
            opacity: 0.6;
        }
        
        td {
            position: relative;
            min-height: 60px;
        }
        
        .course-content {
            position: relative;
            z-index: 1;
            padding: 8px;
        }

        .course-name {
            font-weight: 600 !important;  /* æ–°å¢åŠ ç²—æ ·å¼ */
            margin-bottom: 6px;
        }
        
        .week-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .week-nav button {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #e3e3e8;
            background: white;
            cursor: pointer;
            transition: 0.2s;
        }

        .week-nav button.active {
            background: var(--active-week);
            color: white;
            border-color: var(--active-week);
        }

        .week-card {
            background: white;
            border-radius: 18px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            padding: 20px;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 500;
        }

        .current-course {
            background: #fff8e1 !important;
            box-shadow: inset 0 0 0 2px #ffd54f;
        }

        .time-col {
            width: 100px;
            font-weight: 500;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="week-nav" id="weekNav"></div>
    <div id="timetables"></div>
    <button class="export-btn" onclick="generateICalendar()">ğŸ“… å¯¼å‡ºåˆ°æ—¥å†</button>
    
    <style>
    .export-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 24px;
        background: #007AFF;
        color: white;
        border: none;
        border-radius: 25px;
        font-size: 16px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transition: all 0.2s;
        z-index: 1000;
    }
    
    .export-btn:hover {
        background: #0063CC;
        transform: translateY(-2px);
    }
    </style>
<script>
// åŸºç¡€æ•°æ®
const startDate = new Date(2025, 1, 24); // 2025-02-24
const holidays = [
    { date: '2025-01-29', name: 'æ˜¥èŠ‚' }, // å‡è®¾æ˜¥èŠ‚å‡æœŸ
    { date: '2025-04-04', name: 'æ¸…æ˜' },
    { date: '2025-05-01', name: 'åŠ³åŠ¨èŠ‚' },
    { date: '2025-06-18', name: 'ç«¯åˆ' },
    { date: '2025-09-17', name: 'ä¸­ç§‹' },
    { date: '2025-10-01', name: 'å›½åº†' }
];
const courses = [
    { // æ˜ŸæœŸä¸€
        name: 'é«˜æ•°', weeks: '2-16åŒ', time: '1-2', day: 1,
        classroom: '1-401', class: 'ç½‘å®‰3', color: 'var(--class1)'
    },
    { // æ˜ŸæœŸä¸€
        name: 'æ•°æ¨¡', weeks: '1-16', time: '7-8', day: 1,
        classroom: 'L6-909', class: 'è½¯ä»¶3', color: 'var(--class3)'
    },
    { // æ˜ŸæœŸä¸€æ™šä¸Š
        name: 'é«˜æ•°', weeks: '1-16', time: '9-10', day: 1,
        classroom: '5-604', class: 'ç½‘ç»œ2', color: 'var(--class2)'
    },
    { // æ˜ŸæœŸä¸‰
        name: 'é«˜æ•°', weeks: '1-16', time: '1-2', day: 3,
        classroom: '2-302', class: 'ç½‘å®‰3', color: 'var(--class1)'
    },
    { // æ˜ŸæœŸäº”
        name: 'æ•°æ¨¡', weeks: '1-16', time: '1-2', day: 5,
        classroom: 'L6-902', class: 'è½¯ä»¶3', color: 'var(--class3)'
    },
    { // æ˜ŸæœŸäº”ä¸‹åˆ
        name: 'é«˜æ•°', weeks: '1-15å•', time: '5-6', day: 5,
        classroom: '3-309', class: 'ç½‘ç»œ2', color: 'var(--class2)'
    },
    { // æ˜ŸæœŸå››
        name: 'é«˜æ•°', weeks: '1-17æ— 9', time: '7-8', day: 4,
        classroom: '1-408', class: 'ç”µæ°”5', color: 'var(--class4)'
    },
    { // æ˜ŸæœŸäºŒæ™šä¸Š
        name: 'é«˜æ•°', weeks: '1-17æ— 9', time: '9-10', day: 2,
        classroom: '2-306', class: 'ç”µæ°”5', color: 'var(--class4)'
    }
];

// åˆå§‹åŒ–è¯¾ç¨‹è¡¨
function init() {
    // ç”Ÿæˆå‘¨å¯¼èˆª
    const nav = document.getElementById('weekNav');
    for (let week = 1; week <= 17; week++) {
        const btn = document.createElement('button');
        btn.textContent = `ç¬¬${week}å‘¨`;
        btn.onclick = () => showWeek(week);
        nav.appendChild(btn);
    }

    // ç”Ÿæˆæ‰€æœ‰å‘¨è¯¾è¡¨
    const container = document.getElementById('timetables');
    for (let week = 1; week <= 17; week++) {
        const card = document.createElement('div');
        card.className = 'week-card';
        card.id = `week${week}`;
        card.innerHTML = `
            <h3>ç¬¬ ${week} å‘¨ï¼ˆ${getDateRange(week)}ï¼‰</h3>
            ${renderTable(week)}
        `;
        container.appendChild(card);
    }

    // æ˜¾ç¤ºå½“å‰å‘¨
    showWeek(getCurrentWeek());
    setInterval(highlightCurrent, 60000);
    highlightCurrent();
}

// æ˜¾ç¤ºæŒ‡å®šå‘¨
function showWeek(week) {
    // æ›´æ–°å¯¼èˆªæŒ‰é’®
    document.querySelectorAll('.week-nav button').forEach(btn => {
        btn.classList.toggle('active', btn.textContent === `ç¬¬${week}å‘¨`);
    });

    // æ˜¾ç¤ºå¯¹åº”å‘¨è¯¾è¡¨
    document.querySelectorAll('.week-card').forEach(card => {
        card.style.display = card.id === `week${week}` ? 'block' : 'none';
    });
}

// æ¸²æŸ“è¯¾ç¨‹è¡¨
function renderTable(week) {
    const timeSlots = [
        { time: '1-2', period: 'ä¸Šåˆ' },
        { time: '5-6', period: 'ä¸‹åˆ' },
        { time: '7-8', period: 'ä¸‹åˆ' },
        { time: '9-10', period: 'æ™šä¸Š' }
    ];

    let html = `<table>
        <tr>
            <th class="time-col">æ—¶é—´</th>
            ${[1,2,3,4,5].map(d => {
                const dateStr = getDateStr(week, d);
                const holiday = checkHoliday(dateStr);
                return `
                    <th class="${holiday ? 'holiday-header' : ''}">
                        æ˜ŸæœŸ${['ä¸€','äºŒ','ä¸‰','å››','äº”'][d-1]}
                        <div class="date-info">
                            ${dateStr}
                            ${holiday ? `<span class="holiday-icon">ğŸ‰</span>` : ''}
                        </div>
                    </th>
                `;
            }).join('')}
        </tr>`;

    timeSlots.forEach(slot => {
        html += `<tr>
            <td class="time-col">${slot.time}èŠ‚<br>${slot.period}</td>
            ${[1,2,3,4,5].map(day => {
                const dateStr = getDateStr(week, day);
                const holiday = checkHoliday(dateStr);
                const course = courses.find(c => 
                    checkWeek(week, c.weeks) && 
                    c.day === day && 
                    c.time === slot.time
                );
                
                return `
                    <td style="background:${course?.color || 'transparent'}" 
                        class="${holiday ? 'has-holiday' : ''}">
                        ${course ? `
                            <div class="course-content">
                                <div class="course-name">${course.name}</div>
                                <div class="course-detail">
                                    ${course.classroom}<br>
                                    ${course.class}
                                </div>
                            </div>
                        ` : ''}
                        ${holiday ? `
                            <div class="holiday-mark">
                                <div class="holiday-text">${holiday}</div>
                                <div class="holiday-line"></div>
                            </div>
                        ` : ''}
                    </td>
                `;
            }).join('')}
        </tr>`;
    });

    return html + '</table>';
}
// è¾…åŠ©å‡½æ•°
function checkHoliday(dateStr) {
    const [month, day] = dateStr.split('/');
    const fullDate = `2025-${month.padStart(2,'0')}-${day.padStart(2,'0')}`;
    const holiday = holidays.find(h => h.date === fullDate);
    return holiday?.name || null;
}
function checkWeek(current, condition) {
    if (condition.includes('æ— ')) {
        const [range, exclude] = condition.split('æ— ');
        const [start, end] = range.split('-').map(Number);
        return current >= start && current <= end && current != exclude;
    }
    if (condition.includes('åŒ')) {
        const [start, end] = condition.replace('åŒ','').split('-').map(Number);
        return current >= start && current <= end && current % 2 === 0;
    }
    if (condition.includes('å•')) {
        const [start, end] = condition.replace('å•','').split('-').map(Number);
        return current >= start && current <= end && current % 2 !== 0;
    }
    const [start, end] = condition.split('-').map(Number);
    return current >= start && current <= end;
}

function getCurrentWeek() {
    const now = new Date();
    const diff = Math.floor((now - startDate) / (1000*60*60*24*7));
    return Math.max(1, Math.min(17, diff + 1));
}

function getDateStr(week, day) {
    const date = new Date(startDate);
    date.setDate(date.getDate() + (week-1)*7 + day-1);
    return `${date.getMonth()+1}/${date.getDate()}`;
}

function getDateRange(week) {
    const start = new Date(startDate);
    start.setDate(start.getDate() + (week-1)*7);
    const end = new Date(start);
    end.setDate(start.getDate()+4);
    return `${start.getMonth()+1}/${start.getDate()} - ${end.getMonth()+1}/${end.getDate()}`;
}

function highlightCurrent() {
    const now = new Date();
    const currentWeek = getCurrentWeek();
    const currentDay = now.getDay(); // 0=å‘¨æ—¥
    
    // æ¸…é™¤æ—§é«˜äº®
    document.querySelectorAll('.current-course').forEach(el => {
        el.classList.remove('current-course');
    });

    // å¦‚æœæ˜¯å‘¨æœ«æˆ–éæ•™å­¦æ—¥
    if (currentDay === 0 || currentDay === 6) return;

    // åŒ¹é…å½“å‰æ—¶é—´æ®µ
    const hours = now.getHours();
    let timeSlot = '';
    if (hours >= 8 && hours < 10) timeSlot = '1-2';
    else if (hours >= 14 && hours < 16) timeSlot = '5-6';
    else if (hours >= 16 && hours < 18) timeSlot = '7-8';
    else if (hours >= 19 && hours < 21) timeSlot = '9-10';

    if (timeSlot) {
        const table = document.querySelector(`#week${currentWeek} table`);
        if (table) {
            const cell = table.querySelector(
                `tr:has(td:contains("${timeSlot}èŠ‚")) ~ tr td:nth-child(${currentDay})`
            );
            if (cell) cell.classList.add('current-course');
        }
    }
}
// ç”ŸæˆiCalendaræ–‡ä»¶
function generateICalendar() {
    const icsContent = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//University//Course Schedule//CN',
        'CALSCALE:GREGORIAN',
        ...courses.map((course, index) => {
            const event = createCalendarEvent(course);
            return [
                'BEGIN:VEVENT',
                `UID:${Date.now()}-${index}@university`,
                `SUMMARY:${course.name}`,
                `DESCRIPTION:ç­çº§ï¼š${course.class}\\næ•™å¸ˆï¼šå¾…è¡¥å……`,
                `LOCATION:${course.classroom}`,
                event.dtStart,
                event.dtEnd,
                event.rrule,
                'BEGIN:VALARM',
                'TRIGGER:-PT15M',
                'ACTION:DISPLAY',
                'DESCRIPTION:è¯¾å‰æé†’',
                'END:VALARM',
                'END:VEVENT'
            ].join('\n');
        }),
        'END:VCALENDAR'
    ].join('\n');

    const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'è¯¾ç¨‹è¡¨.ics';
    link.click();
}

// åˆ›å»ºæ—¥å†äº‹ä»¶
function createCalendarEvent(course) {
    const startDate = new Date(2025, 1, 24); // å­¦æœŸå¼€å§‹æ—¥æœŸ
    const startDateTime = calculateFirstOccurrence(startDate, course.day);
    const [startHour, endHour] = getClassHours(course.time);

    return {
        dtStart: `DTSTART;TZID=Asia/Shanghai:${formatICalDate(startDateTime, startHour)}`,
        dtEnd: `DTEND;TZID=Asia/Shanghai:${formatICalDate(startDateTime, endHour)}`,
        rrule: generateRRULE(course.weeks, startDateTime)
    };
}

// è¾…åŠ©å‡½æ•°
function calculateFirstOccurrence(startDate, targetDay) {
    const date = new Date(startDate);
    while (date.getDay() !== targetDay % 7) {
        date.setDate(date.getDate() + 1);
    }
    return date;
}

function getClassHours(timeSlot) {
    const hoursMap = {
        '1-2': [8, 9.5],    // 8:00-9:30
        '5-6': [14, 15.5],  // 14:00-15:30
        '7-8': [16, 17.5],  // 16:00-17:30
        '9-10': [19, 20.5]  // 19:00-20:30
    };
    return hoursMap[timeSlot];
}

function formatICalDate(date, decimalHour) {
    const hour = Math.floor(decimalHour);
    const minute = (decimalHour % 1) * 60;
    const d = new Date(date);
    d.setHours(hour, minute);
    return formatDateToiCal(d);
}

function formatDateToiCal(date) {
    return date.toISOString()
        .replace(/[-:]/g, '')
        .replace(/\.\d+Z$/, '');
}

function generateRRULE(weeksCondition, startDate) {
    const [type, params] = parseWeeks(weeksCondition);
    
    const baseRule = `RRULE:FREQ=WEEKLY;INTERVAL=1;BYDAY=${getDayAbbreviation(startDate.getDay())}`;
    
    switch(type) {
        case 'single':
            return `${baseRule};COUNT=${params.totalWeeks}`;
        case 'double':
            return `${baseRule};INTERVAL=2;COUNT=${Math.ceil(params.totalWeeks/2)}`;
        case 'exclude':
            return `${baseRule};UNTIL=${formatDateToiCal(params.untilDate)};EXDATE=${params.exdates.join(',')}`;
        default:
            return `${baseRule};UNTIL=${formatDateToiCal(params.untilDate)}`;
    }
}

function parseWeeks(condition) {
    // éœ€è¦æ ¹æ®å®é™…æƒ…å†µå®ç°æ¡ä»¶è§£æé€»è¾‘
    // è¿”å›æ ¼å¼ç¤ºä¾‹ï¼š['single', {totalWeeks: 16}]
}
// å¯åŠ¨ç¨‹åº
document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
